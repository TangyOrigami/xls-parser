import xlrd
from datetime import datetime
from util.user import User
from util.db import DBInterface
from util.logger import CLogger
from util.parser import Parser as p

logger = CLogger().get_logger()


class Controller:
    '''
        Interface to interact with utility classes to extract user
        data from XLS file generated by TimeTrax timeclocks.
    '''

    def extract_data(self, file_path) -> []:
        '''
            Method that takes in the path to file and returns
            a list of User objects from the file.
        '''

        workbook = xlrd.open_workbook(file_path)

        users = []

        for i in range(0, workbook.nsheets):
            temp = []
            dates = []
            hrs = []
            datesNhrs = []

            currentSheet = workbook.sheet_by_index(i)

            date = self.__get_date(currentSheet)

            name = self.__get_name(currentSheet)

            group = self.__get_group(currentSheet)

            comm_date = self.__get_comm_date(currentSheet)

            pi_comm = self.__get_pi_comm(currentSheet)

            po_comm = self.__get_po_comm(currentSheet)

            sp_comm = self.__get_sp_comm(currentSheet)

            comments = [comm_date, pi_comm, po_comm, sp_comm]

            dailyHrsCol = self.__get_dailyHrsCol(currentSheet)

            temp.append(p.xlsParser(sheet=currentSheet,
                                    mincolx=dailyHrsCol[1],
                                    minrowy=dailyHrsCol[0]+1,
                                    maxcolx=dailyHrsCol[1]+1,
                                    maxrowy=currentSheet.nrows,
                                    target="[0-9]*:[0-9]*",
                                    xbuff=None,
                                    ybuff=None)
                        )

            for i in range(0, len(temp[0]), 2):
                hrs.append(p.hrsFormatter(temp[0][i]))

            for i in range(1, len(temp[0]), 2):
                currDate = [temp[0][i][0], 1]
                dates.append(
                    f"{currentSheet.cell_value(rowx=currDate[0], colx=currDate[1])}")

            for i in range(len(dates)):
                datesNhrs.append([dates[i], hrs[i]])

            curr_user = User(name=name[0], group=group,
                             start_date=date, report=datesNhrs,
                             comments=comments)

            users.append(curr_user)

        return users

    def __get_date(self, sheet) -> datetime:
        date = datetime.strptime(
            p.xlsParser(sheet=sheet,
                        mincolx=0, minrowy=0,
                        maxcolx=25, maxrowy=25,
                        target="[0-9].(AM|PM)",
                        xbuff=None,
                        ybuff=None)[0].split(" ", 1)[0], "%m/%d/%Y").date()
        return date

    def __get_name(self, sheet) -> datetime:
        name = p.xlsParser(sheet=sheet,
                           mincolx=0, minrowy=0,
                           maxcolx=35, maxrowy=35,
                           target="User Name:",
                           xbuff=2,
                           ybuff=None)
        return name

    def __get_group(self, sheet) -> datetime:
        group = p.xlsParser(sheet=sheet,
                            mincolx=0, minrowy=0,
                            maxcolx=3, maxrowy=35,
                            target="Employee Group",
                            xbuff=8,
                            ybuff=None)[0]
        return group

    def __get_comm_date(self, sheet) -> datetime:
        comm_date = p.xlsParser(sheet=sheet,
                                mincolx=1, minrowy=sheet.nrows-2,
                                maxcolx=2,
                                maxrowy=sheet.nrows-1,
                                target="DATE",
                                xbuff=None,
                                ybuff=1)
        return comm_date

    def __get_pi_comm(self, sheet) -> datetime:
        pi_comm = p.xlsParser(sheet=sheet,
                              mincolx=1, minrowy=sheet.nrows-2,
                              maxcolx=sheet.ncols,
                              maxrowy=sheet.nrows-1,
                              target="IN PUNCH COMMENT",
                              xbuff=None,
                              ybuff=1)
        return pi_comm

    def __get_po_comm(self, sheet) -> datetime:
        po_comm = p.xlsParser(sheet=sheet,
                              mincolx=1, minrowy=sheet.nrows-2,
                              maxcolx=sheet.ncols,
                              maxrowy=sheet.nrows-1,
                              target="OUT PUNCH COMMENT",
                              xbuff=None,
                              ybuff=1)
        return po_comm

    def __get_sp_comm(self, sheet) -> datetime:
        sp_comm = p.xlsParser(sheet=sheet,
                              mincolx=1, minrowy=sheet.nrows-2,
                              maxcolx=sheet.ncols,
                              maxrowy=sheet.nrows-1,
                              target="SPECIAL PAY COMMENT",
                              xbuff=None,
                              ybuff=1)
        return sp_comm

    def __get_dailyHrsCol(self, sheet) -> datetime:
        dailyHrsCol = p.xlsParser(sheet=sheet,
                                  mincolx=0, minrowy=0,
                                  maxcolx=sheet.ncols,
                                  maxrowy=sheet.nrows,
                                  target="DAILY",
                                  xbuff=None,
                                  ybuff=None)[1]
        return dailyHrsCol

    def _test_print(users):
        '''
            Testing method that prints the result from
            `Controller.extract_data()` to the terminal.

            Development use only.
        '''

        for i in range(len(users)):
            gp = users[i]

            actualWeekly = sum(gp.get_weekday_hrs().values())
            weekend = sum(gp.get_weekend_hrs().values())
            otWeekly = sum(gp.get_ot_logged().values())

            print(f"{i}, '{gp.name}', '{gp.start_date}'")
            print("Total:\t", sum(gp.get_hrs_wrked().values()),
                  "\nRT:\t", actualWeekly - otWeekly,
                  "\nOT:\t", otWeekly, "\nWknd:\t", weekend,
                  "\nLog:\n", gp.get_hrs_wrked())
            print()
